<Page
    x:Class="SystemInfoViewer.AppMgmt"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:helpers="using:SystemInfoViewer.Helpers"
    mc:Ignorable="d">

    <ScrollViewer Padding="16" VerticalScrollBarVisibility="Auto">
        <StackPanel Spacing="16">
            <!-- 导航路径 -->
            <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,0,0,10">
                <Button 
                    Click="ToolsLink_Click"
                    Padding="0"
                    BorderThickness="0"
                    Background="Transparent">
                    <Button.Template>
                        <ControlTemplate TargetType="Button">
                            <Grid>
                                <VisualStateManager.VisualStateGroups>
                                    <VisualStateGroup x:Name="CommonStates">
                                        <VisualState x:Name="Normal"/>
                                        <VisualState x:Name="PointerOver">
                                            <Storyboard>
                                                <ObjectAnimationUsingKeyFrames Storyboard.TargetName="ToolsLink" Storyboard.TargetProperty="Foreground">
                                                    <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource TextFillColorPrimaryBrush}"/>
                                                </ObjectAnimationUsingKeyFrames>
                                            </Storyboard>
                                        </VisualState>
                                    </VisualStateGroup>
                                </VisualStateManager.VisualStateGroups>

                                <TextBlock 
                                    x:Name="ToolsLink" 
                                    Text="工具" 
                                    Style="{StaticResource LinkTextStyle}"
                                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                    IsHitTestVisible="True"/>
                            </Grid>
                        </ControlTemplate>
                    </Button.Template>
                </Button>

                <TextBlock Text=">" 
                           Style="{StaticResource BodyTextBlockStyle}"/>
                <TextBlock Text="应用管理" 
                           Style="{StaticResource HeaderTextBlockStyle}"
                           Margin="0"/>
            </StackPanel>

            <!-- 总数和匹配项显示 -->
            <TextBlock x:Name="TotalCountText"
                       Text="共 0 个应用"
                       Style="{StaticResource BodyTextBlockStyle}"
                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>

            <!-- 搜索和刷新区域 -->
            <Grid Margin="0,0,0,16" ColumnSpacing="12">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBox 
                    x:Name="SearchBox"
                    PlaceholderText="搜索应用..."
                    TextChanged="SearchBox_TextChanged"
                    HorizontalAlignment="Stretch"
                    FontSize="14"
                    Padding="12,8"
                    CornerRadius="4"
                    BorderThickness="1"
                    BorderBrush="{ThemeResource CardBorderBrush}"
                    Background="{ThemeResource CardBackgroundBrush}"/>

                <Button 
                    x:Name="RefreshButton"
                    Grid.Column="1"
                    Click="RefreshButton_Click"
                    HorizontalAlignment="Left"
                    Height="{Binding ActualHeight, ElementName=SearchBox}"
                    MinWidth="100"
                    Padding="12,0">
                    <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                        <SymbolIcon Symbol="Refresh"/>
                        <TextBlock Text="刷新" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>
            </Grid>

            <Grid MinHeight="400">
                <!-- 加载指示器 -->
                <StackPanel x:Name="LoadingIndicator" Visibility="Collapsed" 
                            HorizontalAlignment="Center" VerticalAlignment="Center">
                    <ProgressRing IsActive="True" Width="40" Height="40"/>
                    <TextBlock Text="正在加载已安装的应用..." 
                               Style="{StaticResource BodyTextBlockStyle}" 
                               Margin="0,8,0,0"
                               TextAlignment="Center"/>
                </StackPanel>

                <!-- 空状态 -->
                <StackPanel x:Name="EmptyState" Visibility="Collapsed" 
                            HorizontalAlignment="Center" VerticalAlignment="Center">
                    <TextBlock Text="未找到应用程序" 
                               Style="{StaticResource SubtitleTextBlockStyle}"
                               TextAlignment="Center"/>
                    <TextBlock Text="尝试刷新列表或检查系统设置" 
                               Style="{StaticResource BodyTextBlockStyle}" 
                               Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                               TextAlignment="Center"
                               Margin="0,8,0,0"/>
                </StackPanel>

                <!-- 应用列表 - 使用ItemsRepeater实现虚拟化 -->
                <ScrollViewer x:Name="AppListScrollViewer"
                              Visibility="Collapsed"
                              Margin="0,8,0,0">
                    <ItemsRepeater x:Name="SoftwareRepeater"
                                  ItemsSource="{x:Bind FilteredSoftware, Mode=OneWay}">
                        <ItemsRepeater.Layout>
                            <StackLayout Orientation="Vertical" Spacing="8"/>
                        </ItemsRepeater.Layout>
                        <ItemsRepeater.ItemTemplate>
                            <DataTemplate x:DataType="helpers:SoftwareInfo">
                                <StackPanel Margin="0,4">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="150"/>
                                            <ColumnDefinition Width="120"/>
                                            <ColumnDefinition Width="100"/>
                                        </Grid.ColumnDefinitions>

                                        <!-- 应用名称和发布者 -->
                                        <StackPanel Grid.Column="0">
                                            <TextBlock 
                                                Text="{x:Bind DisplayName}" 
                                                Style="{StaticResource SubtitleTextBlockStyle}" 
                                                Margin="0"/>
                                            <TextBlock 
                                                Text="{x:Bind Publisher}" 
                                                Style="{StaticResource CaptionTextBlockStyle}" 
                                                Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                        </StackPanel>

                                        <!-- 版本 -->
                                        <TextBlock 
                                            Grid.Column="1" 
                                            Text="{x:Bind Version}" 
                                            Style="{StaticResource BodyTextBlockStyle}"
                                            VerticalAlignment="Center"/>

                                        <!-- 安装日期 -->
                                        <TextBlock 
                                            Grid.Column="2" 
                                            Text="{x:Bind FormattedInstallDate}" 
                                            Style="{StaticResource BodyTextBlockStyle}"
                                            VerticalAlignment="Center"/>

                                        <!-- 卸载按钮 -->
                                        <Button 
                                            Grid.Column="3"
                                            Content="卸载" 
                                            Click="UninstallButton_Click"
                                            Tag="{x:Bind UninstallString}"
                                            DataContext="{x:Bind}"
                                            IsEnabled="{x:Bind HasUninstallString}"
                                            HorizontalAlignment="Right"/>
                                    </Grid>
                                    <Border Height="1" Background="{ThemeResource CardBorderBrush}" Margin="0,8,0,0"/>
                                </StackPanel>
                            </DataTemplate>
                        </ItemsRepeater.ItemTemplate>
                    </ItemsRepeater>
                </ScrollViewer>
            </Grid>
        </StackPanel>
    </ScrollViewer>
</Page>